<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compilatore PDF XFA - ATS Monza Brianza (Mega-Batch Pro)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        .log-area {
            background: #000;
            color: #00ff00;
            font-family: monospace;
            padding: 15px;
            border-radius: 8px;
            min-height: 200px;
            max-height: 400px;
            overflow-y: auto;
            font-size: 12px;
        }
        .btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }
        .btn:disabled {
            background: #ccc !important;
            cursor: not-allowed;
            opacity: 0.6;
        }
        .btn-blue { background: #3b82f6; color: white; }
        .btn-green { background: #10b981; color: white; }
        .btn-purple { background: #8b5cf6; color: white; }
        .btn-red { background: #ef4444; color: white; }
        .btn-orange { background: #f97316; color: white; }
        .status-ok { color: #10b981; }
        .status-error { color: #ef4444; }
        .progress-bar {
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
            transition: width 0.3s ease;
        }
        .mega-batch-indicator {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="container mx-auto p-6 max-w-6xl">
        <!-- Header -->
        <div class="bg-gradient-to-r from-blue-600 to-green-600 text-white p-6 rounded-lg mb-6 text-center">
            <h1 class="text-3xl font-bold mb-2">üìã Compilatore PDF XFA Pro</h1>
            <p class="opacity-90">Compila automaticamente fino a 200+ record con tecnologia Mega-Batch</p>
            <div class="mega-batch-indicator mt-2 inline-block">üöÄ MEGA-BATCH READY</div>
        </div>

        <!-- Performance Indicator -->
        <div class="bg-orange-50 border border-orange-200 p-4 rounded-lg mb-6">
            <h2 class="text-lg font-bold text-orange-700 mb-2">‚ö° Tecnologia Mega-Batch Pro</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                <div class="text-center">
                    <div class="text-2xl font-bold text-orange-600">200+</div>
                    <div class="text-orange-700">Record supportati</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-orange-600">45s</div>
                    <div class="text-orange-700">Timeout esteso</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-orange-600">1x</div>
                    <div class="text-orange-700">Singola chiamata API</div>
                </div>
            </div>
        </div>

        <!-- Instructions -->
        <div class="bg-blue-50 border border-blue-200 p-6 rounded-lg mb-6">
            <h2 class="text-lg font-bold text-blue-700 mb-3">‚ÑπÔ∏è Come funziona il Mega-Batch</h2>
            <ol class="list-decimal list-inside space-y-2 text-sm">
                <li>Inserisci la tua API Key di pdfRest (preconfigurata per test).</li>
                <li>Carica il file CSV con i dati del personale (supporta fino a 200+ record).</li>
                <li>Carica il PDF XFA da compilare.</li>
                <li>(Opzionale) Clicca "Analizza Campi PDF" per verificare la struttura.</li>
                <li><strong>üöÄ Clicca "Mega-Batch Compile" per processare TUTTI i record in una sola chiamata!</strong></li>
            </ol>
            <div class="mt-3 p-3 bg-green-50 border border-green-200 rounded">
                <p class="text-sm text-green-800">
                    <strong>üí° Novit√†:</strong> Il sistema ora genera un singolo XML con tutti i record e lo invia in una mega-chiamata. 
                    In caso di timeout, attiva automaticamente il fallback client-side.
                </p>
            </div>
        </div>

        <!-- API Configuration -->
        <div class="bg-white p-6 rounded-lg shadow mb-6">
            <h2 class="text-xl font-bold mb-4 text-blue-700">üîë Configurazione API pdfRest</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-bold mb-2">API Key:</label>
                    <div class="flex space-x-2">
                        <input 
                            type="password" 
                            id="apiKeyInput" 
                            placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
                            class="flex-1 p-3 border rounded font-mono text-sm"
                            value="bc95f9dc-d3e0-4b30-8da0-53f6deb83712"
                        >
                        <button id="toggleKeyBtn" class="btn btn-blue px-3">üëÅÔ∏è</button>
                    </div>
                    <div id="apiStatus" class="mt-2 text-sm"></div>
                </div>
                <div class="flex flex-col justify-end">
                    <button id="saveApiBtn" class="btn btn-green mb-2">üíæ Salva API Key</button>
                </div>
            </div>
        </div>

        <!-- File Upload -->
        <div class="bg-white p-6 rounded-lg shadow mb-6">
            <h2 class="text-xl font-bold mb-4 text-purple-700">üìÅ Caricamento File</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="border-2 border-dashed border-green-400 rounded-lg p-6">
                    <div class="text-center mb-4">
                        <div class="text-4xl mb-2">üìä</div>
                        <h3 class="font-bold mb-2">File CSV Personale</h3>
                        <p class="text-xs text-gray-600 mb-3">Supporta fino a 200+ record</p>
                        <input type="file" id="csvFileInput" accept=".csv" class="hidden">
                        <button id="selectCSVBtn" class="btn btn-green">üìÇ Seleziona CSV</button>
                    </div>
                    <div id="csvStatus" class="text-sm mb-3"></div>
                    <div id="csvPreview" class="hidden bg-gray-50 p-3 rounded text-xs max-h-40 overflow-y-auto"></div>
                </div>
                <div class="border-2 border-dashed border-purple-400 rounded-lg p-6">
                    <div class="text-center mb-4">
                        <div class="text-4xl mb-2">üìÑ</div>
                        <h3 class="font-bold mb-2">PDF XFA ATS</h3>
                        <input type="file" id="pdfFileInput" accept=".pdf" class="hidden">
                        <button id="selectPDFBtn" class="btn btn-purple">üìÇ Seleziona PDF</button>
                    </div>
                    <div id="pdfStatus" class="text-sm mb-3"></div>
                </div>
            </div>
        </div>

        <!-- Process Control -->
        <div class="bg-white p-6 rounded-lg shadow mb-6">
            <h2 class="text-xl font-bold mb-4 text-green-700">üöÄ Azioni Mega-Batch</h2>
            
            <!-- Mega-Batch Status -->
            <div id="megaBatchStatus" class="mb-6 p-4 bg-gradient-to-r from-purple-50 to-blue-50 rounded-lg hidden">
                <h3 class="font-bold text-purple-700 mb-3">üöÄ Status Mega-Batch</h3>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 text-sm">
                    <div class="text-center">
                        <div id="recordCountDisplay" class="text-lg font-bold text-purple-600">0</div>
                        <div class="text-gray-600">Record totali</div>
                    </div>
                    <div class="text-center">
                        <div id="xmlSizeDisplay" class="text-lg font-bold text-blue-600">0KB</div>
                        <div class="text-gray-600">Dimensione XML</div>
                    </div>
                    <div class="text-center">
                        <div id="estimatedTimeDisplay" class="text-lg font-bold text-green-600">~30s</div>
                        <div class="text-gray-600">Tempo stimato</div>
                    </div>
                    <div class="text-center">
                        <div id="strategyDisplay" class="text-lg font-bold text-orange-600">MEGA</div>
                        <div class="text-gray-600">Strategia</div>
                    </div>
                </div>
            </div>
            
            <div class="text-center mb-4 space-x-4">
                <button id="convertBtn" class="btn btn-blue" disabled>üîÑ XFA ‚Üí Acroforms</button>
                <button id="compileBtn" class="btn btn-orange text-lg px-8 py-4" disabled>
                    üöÄ MEGA-BATCH COMPILE
                </button>
                <button id="debugBtn" class="btn btn-blue" disabled>üîç Analizza Campi PDF</button>
                <button id="exportBtn" class="btn btn-green" disabled>üì§ Esporta Struttura XFA</button>
                <p class="text-sm text-gray-600 mt-2" id="recordCount">In attesa dei file...</p>
            </div>
            
            <!-- Progress with Mega-Batch Details -->
            <div id="processProgress" class="hidden mb-4">
                <div class="progress-bar mb-2">
                    <div id="progressFill" class="progress-fill" style="width: 0%"></div>
                </div>
                <div class="flex justify-between items-center">
                    <div id="progressText" class="text-sm">Preparazione...</div>
                    <div id="progressTime" class="text-xs text-gray-500">0s</div>
                </div>
                <div id="progressDetails" class="text-xs text-gray-600 mt-1"></div>
            </div>
        </div>

        <!-- Fallback Section -->
        <div id="fallbackSection" class="bg-yellow-50 border border-yellow-200 p-6 rounded-lg mb-6 hidden">
            <h2 class="text-xl font-bold mb-4 text-yellow-700">‚ö†Ô∏è Modalit√† Fallback Attiva</h2>
            <div class="space-y-3">
                <p class="text-sm text-yellow-800">
                    Il mega-batch ha superato i limiti di timeout di Netlify. √à possibile procedere con la modalit√† fallback:
                </p>
                <div class="bg-yellow-100 p-3 rounded border">
                    <h4 class="font-bold text-yellow-700 mb-2">üîß Modalit√† Fallback:</h4>
                    <ul class="text-sm text-yellow-800 space-y-1">
                        <li>‚Ä¢ Chiamata diretta dal browser a pdfRest API</li>
                        <li>‚Ä¢ Bypassa i limiti di Netlify Functions</li>
                        <li>‚Ä¢ ‚ö†Ô∏è API Key temporaneamente esposta nel browser</li>
                        <li>‚Ä¢ ‚úÖ Gestisce fino a 300+ record senza limiti</li>
                    </ul>
                </div>
                <button id="fallbackBtn" class="btn btn-orange">üöÄ Attiva Modalit√† Fallback</button>
            </div>
        </div>

        <!-- Results -->
        <div id="resultsSection" class="bg-white p-6 rounded-lg shadow mb-6 hidden">
            <h2 class="text-xl font-bold mb-4 text-green-700">‚úÖ Risultato Mega-Batch</h2>
            <div id="resultsContent"></div>
        </div>

        <!-- Log -->
        <div class="bg-white p-6 rounded-lg shadow">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-700">üìã Log Operazioni Mega-Batch</h2>
                <button id="clearLogBtn" class="btn btn-red text-sm">üóëÔ∏è Pulisci</button>
            </div>
            <div id="logArea" class="log-area"></div>
        </div>
    </div>

    <script>
        // Global state - Enhanced for Mega-Batch
        const state = {
            apiKey: 'bc95f9dc-d3e0-4b30-8da0-53f6deb83712',
            csvData: null,
            pdfFile: null,
            pdfResourceId: null,
            compiledPdfUrl: null,
            acroformsPdfUrl: null,
            selectedPages: { start: null, end: null },
            xfaStructure: null,
            megaBatchMode: true, // ‚úÖ NUOVO: Modalit√† mega-batch attiva
            fallbackMode: false, // ‚úÖ NUOVO: Modalit√† fallback
            processingStartTime: null, // ‚úÖ NUOVO: Tracking tempo
            fieldMapping: {
                'COGNOME': 'cognome',
                'NOME': 'nome',
                'C.F.': 'codice_fiscale',
                'Qualifica (Q)': 'qualifica',
                'Tipo rapporto': 'rapporto_lavoro',
                'Tipo contratto (TC)': 'contratto_lavoro',
                'N. ore sett. Da contratto': 'n_ore_settimanali',
                'N. sett. Anno': 'n_settimane',
                'N. ore tot.': 'n_ore_totale',
                'di cui straordinari': 'n_ore_straordinarie'
            }
        };

        const API_BASE = '/api';

        // ‚úÖ NUOVO: Enhanced logging with timestamps and mega-batch context
        function log(message, type = 'info') {
            const now = new Date().toLocaleTimeString();
            const colors = {
                'info': '#00ff00',
                'warn': '#ffff00', 
                'error': '#ff0000',
                'success': '#00ffff',
                'api': '#ff69b4',
                'megabatch': '#ffa500' // ‚úÖ NUOVO: Colore specifico per mega-batch
            };
            const logArea = document.getElementById('logArea');
            const color = colors[type] || '#00ff00';
            
            // ‚úÖ NUOVO: Prefix per operazioni mega-batch
            const prefix = state.megaBatchMode && type === 'api' ? '[MEGA-BATCH]' : '';
            
            logArea.innerHTML += `<div style="color: ${color};">[${now}] ${prefix} ${message}</div>`;
            logArea.scrollTop = logArea.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${prefix} ${message}`);
        }

        // ‚úÖ NUOVO: Progress tracking con dettagli tempo
        function updateProgress(percent, text, details = '') {
            document.getElementById('progressFill').style.width = percent + '%';
            document.getElementById('progressText').textContent = text;
            
            // Aggiorna tempo trascorso
            if (state.processingStartTime) {
                const elapsed = Math.round((Date.now() - state.processingStartTime) / 1000);
                document.getElementById('progressTime').textContent = `${elapsed}s`;
            }
            
            // Aggiorna dettagli se forniti
            if (details) {
                document.getElementById('progressDetails').textContent = details;
            }
        }

        // ‚úÖ NUOVO: Mega-Batch status display
        function updateMegaBatchStatus() {
            if (!state.csvData) return;
            
            const recordCount = state.csvData.length;
            const xmlSize = Math.round(estimateXMLSize(recordCount) / 1024); // KB
            const estimatedTime = recordCount <= 50 ? '~15s' : recordCount <= 100 ? '~25s' : recordCount <= 200 ? '~35s' : '~45s';
            const strategy = recordCount <= 30 ? 'SINGLE' : 'MEGA';
            
            document.getElementById('recordCountDisplay').textContent = recordCount;
            document.getElementById('xmlSizeDisplay').textContent = `${xmlSize}KB`;
            document.getElementById('estimatedTimeDisplay').textContent = estimatedTime;
            document.getElementById('strategyDisplay').textContent = strategy;
            
            document.getElementById('megaBatchStatus').classList.remove('hidden');
        }

        // ‚úÖ NUOVO: Stima dimensione XML
        function estimateXMLSize(recordCount) {
            const avgFieldSize = 20; // caratteri medi per campo
            const fieldsPerRecord = Object.keys(state.fieldMapping).length + 5; // campi extra
            const xmlOverhead = 200; // overhead XML
            
            return recordCount * fieldsPerRecord * avgFieldSize + xmlOverhead;
        }

        // ‚úÖ MEGA-BATCH: Generazione XML ottimizzata
        function generateMegaBatchXML(records) {
            log(`üîß Generazione XML mega-batch per ${records.length} record...`, 'megabatch');
            
            let xmlData = '<?xml version="1.0" encoding="UTF-8"?>\n';
            xmlData += '<welfare xmlns="http://schemas.sygest.it/adobe">\n';
            
            records.forEach((record, index) => {
                xmlData += '  <personale_standard>\n';
                
                Object.entries(state.fieldMapping).forEach(([csvField, xfaField]) => {
                    const value = record[csvField] || '';
                    // ‚úÖ OTTIMIZZATO: Escape XML pi√π efficiente
                    const escapedValue = value.replace(/[&<>"']/g, (char) => {
                        const escapeMap = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&apos;' };
                        return escapeMap[char];
                    });
                    xmlData += `    <${xfaField}>${escapedValue}</${xfaField}>\n`;
                });
                
                // Campi obbligatori
                xmlData += '    <qualifica_altro/>\n';
                xmlData += '    <medico_responsabile>false</medico_responsabile>\n';
                xmlData += '    <contratto_lavoro_altro/>\n';
                xmlData += '    <setting_ria/>\n';
                xmlData += '    <n_ore_altri_ser_int/>\n';
                
                xmlData += '  </personale_standard>\n';
                
                // Progress update ogni 25 record
                if (index % 25 === 0 && index > 0) {
                    const progress = Math.round((index / records.length) * 30); // 30% del progresso totale
                    updateProgress(progress, `Generazione XML: ${index}/${records.length} record...`, 
                                 `Dimensione XML: ~${Math.round(xmlData.length / 1024)}KB`);
                }
            });
            
            xmlData += '</welfare>';
            
            const finalSizeKB = Math.round(xmlData.length / 1024);
            log(`‚úÖ XML mega-batch generato: ${records.length} record, ${finalSizeKB}KB`, 'success');
            
            return xmlData;
        }

        // ‚úÖ MEGA-BATCH: Compilazione principale
        async function compilePDF_MegaBatch() {
            log('üöÄ AVVIO MEGA-BATCH PROCESSING...', 'megabatch');
            
            const totalRecords = state.csvData.length;
            state.processingStartTime = Date.now();
            
            log(`üìä MEGA-BATCH TARGET: ${totalRecords} record ‚Üí 1 chiamata API`, 'megabatch');
            log(`üéØ Strategia: Singolo XML con tutti i record (bypass batch tradizionali)`, 'info');
            
            try {
                // STEP 1: Generazione XML
                updateProgress(10, 'Avvio generazione XML mega-batch...', 'Preparazione struttura dati');
                const xmlData = generateMegaBatchXML(state.csvData);
                
                updateProgress(40, 'XML generato, preparazione chiamata API...', `XML pronto: ${Math.round(xmlData.length / 1024)}KB`);
                
                // STEP 2: Preparazione FormData
                const form = new FormData();
                form.append('id', state.pdfResourceId);
                
                const dataBlob = new Blob([xmlData], { type: 'application/xml' });
                const timestamp = new Date().toISOString().slice(0,19).replace(/:/g,'-');
                const filename = `welfare_megabatch_${totalRecords}records_${timestamp}.xml`;
                form.append('data_file', dataBlob, filename);
                form.append('output', `documento_megabatch_${totalRecords}rec_${timestamp}`);
                
                updateProgress(50, 'Invio mega-batch a pdfRest API...', 'Timeout esteso: 45s');
                
                // STEP 3: ‚úÖ CHIAMATA MEGA-BATCH con timeout esteso
                log('üöÄ Invio MEGA-BATCH (timeout 45s, keepalive attivo)...', 'api');
                
                // ‚úÖ Keepalive per mantenere viva la connessione
                const keepaliveInterval = setInterval(() => {
                    log('‚è≥ Mega-batch in elaborazione... (keepalive)', 'info');
                }, 5000);
                
                const response = await fetch(`${API_BASE}/pdf-with-imported-form-data`, {
                    method: 'POST',
                    body: form,
                    // ‚úÖ Timeout browser esteso (deve essere < timeout Netlify)
                    signal: AbortSignal.timeout(43000) // 43s (meno di Netlify 45s)
                });
                
                clearInterval(keepaliveInterval);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Mega-batch API error: ${response.status} - ${errorText}`);
                }
                
                const data = await response.json();
                state.compiledPdfUrl = data.outputUrl;
                
                const elapsedTime = Math.round((Date.now() - state.processingStartTime) / 1000);
                updateProgress(100, 'MEGA-BATCH COMPLETATO!', `Elaborati ${totalRecords} record in ${elapsedTime}s`);
                
                log('‚úÖ MEGA-BATCH SUCCESS! üéâ', 'success');
                log(`üìä Performance: ${totalRecords} record in ${elapsedTime}s (${Math.round(totalRecords/elapsedTime)} rec/s)`, 'success');
                log(`üìÑ PDF generato: ${data.outputUrl}`, 'success');
                
                showMegaBatchResults();
                
            } catch (error) {
                log(`‚ùå MEGA-BATCH FAILED: ${error.message}`, 'error');
                
                if (error.name === 'TimeoutError' || error.message.includes('timeout')) {
                    log('‚è∞ TIMEOUT rilevato - Attivazione modalit√† fallback disponibile', 'warn');
                    showFallbackOption();
                } else {
                    throw error;
                }
            }
        }

        // ‚úÖ FALLBACK: Modalit√† chiamata diretta
        async function executeFallbackMode() {
            log('üîÑ ATTIVAZIONE MODALIT√Ä FALLBACK...', 'warn');
            log('‚ö†Ô∏è ATTENZIONE: Chiamata diretta al browser (API key temporaneamente esposta)', 'warn');
            
            const userConfirm = confirm(
                'üö® MODALIT√Ä FALLBACK\n\n' +
                'Il mega-batch ha superato i limiti di Netlify Functions.\n\n' +
                '‚úÖ SOLUZIONE: Chiamata diretta dal browser\n' +
                '‚ö†Ô∏è AVVISO: La tua API key sar√† temporaneamente visibile\n' +
                'üéØ RISULTATO: Elaborazione di tutti i record senza limiti\n\n' +
                'Vuoi procedere?'
            );
            
            if (!userConfirm) {
                log('‚ùå Modalit√† fallback annullata dall\'utente', 'info');
                return;
            }
            
            state.fallbackMode = true;
            document.getElementById('fallbackSection').classList.add('hidden');
            document.getElementById('processProgress').classList.remove('hidden');
            
            try {
                const totalRecords = state.csvData.length;
                state.processingStartTime = Date.now();
                
                updateProgress(20, 'Fallback: Generazione XML...', 'Modalit√† diretta attiva');
                const xmlData = generateMegaBatchXML(state.csvData);
                
                updateProgress(50, 'Fallback: Chiamata diretta a pdfRest...', 'Bypass Netlify timeout');
                
                const form = new FormData();
                form.append('id', state.pdfResourceId);
                const dataBlob = new Blob([xmlData], { type: 'application/xml' });
                form.append('data_file', dataBlob, `welfare_fallback_${totalRecords}records.xml`);
                form.append('output', `documento_fallback_${totalRecords}rec`);
                
                log('üöÄ FALLBACK: Chiamata diretta (bypass proxy)...', 'api');
                
                // ‚úÖ CHIAMATA DIRETTA (bypassa Netlify Functions)
                const response = await fetch('https://api.pdfrest.com/pdf-with-imported-form-data', {
                    method: 'POST',
                    headers: {
                        'Api-Key': state.apiKey, // ‚ö†Ô∏è API key esposta
                    },
                    body: form,
                    signal: AbortSignal.timeout(90000) // 90s senza limiti Netlify
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Fallback failed: ${response.status} - ${errorText}`);
                }
                
                const data = await response.json();
                state.compiledPdfUrl = data.outputUrl;
                
                const elapsedTime = Math.round((Date.now() - state.processingStartTime) / 1000);
                updateProgress(100, 'FALLBACK COMPLETATO!', `Elaborati ${totalRecords} record in ${elapsedTime}s`);
                
                log('‚úÖ FALLBACK SUCCESS! üéâ', 'success');
                log('üîí API key exposure terminata', 'info');
                log(`üìä Performance fallback: ${totalRecords} record in ${elapsedTime}s`, 'success');
                
                showMegaBatchResults();
                
            } catch (error) {
                log(`‚ùå FALLBACK FAILED: ${error.message}`, 'error');
                state.fallbackMode = false;
                throw error;
            }
        }

        // ‚úÖ NUOVO: Mostra opzione fallback
        function showFallbackOption() {
            document.getElementById('fallbackSection').classList.remove('hidden');
            document.getElementById('processProgress').classList.add('hidden');
        }

        // ‚úÖ NUOVO: Risultati mega-batch
        function showMegaBatchResults() {
            const section = document.getElementById('resultsSection');
            const content = document.getElementById('resultsContent');
            
            const totalRecords = state.csvData.length;
            const elapsedTime = Math.round((Date.now() - state.processingStartTime) / 1000);
            const mode = state.fallbackMode ? 'Fallback' : 'Mega-Batch';
            const recordsPerSecond = Math.round(totalRecords / elapsedTime);
            
            let html = '<div class="text-center space-y-4">';
            html += `<h3 class="text-2xl font-bold text-green-600">üéâ ${mode} Completato!</h3>`;
            html += '<div class="grid grid-cols-1 md:grid-cols-3 gap-4 my-6">';
            html += `<div class="bg-green-50 p-4 rounded-lg">
                        <div class="text-2xl font-bold text-green-600">${totalRecords}</div>
                        <div class="text-sm text-gray-600">Record processati</div>
                     </div>`;
            html += `<div class="bg-blue-50 p-4 rounded-lg">
                        <div class="text-2xl font-bold text-blue-600">${elapsedTime}s</div>
                        <div class="text-sm text-gray-600">Tempo totale</div>
                     </div>`;
            html += `<div class="bg-purple-50 p-4 rounded-lg">
                        <div class="text-2xl font-bold text-purple-600">${recordsPerSecond}/s</div>
                        <div class="text-sm text-gray-600">Record al secondo</div>
                     </div>`;
            html += '</div>';
            
            if (state.compiledPdfUrl) {
                html += `<a href="${state.compiledPdfUrl}" target="_blank" class="btn btn-green inline-block text-lg px-8 py-4">
                           üì• SCARICA PDF COMPILATO
                         </a>`;
            }
            
            html += '<div class="mt-6 p-4 bg-gray-50 rounded-lg text-left text-sm">';
            html += '<h4 class="font-bold mb-2">üìä Dettagli Elaborazione:</h4>';
            html += `<ul class="space-y-1">`;
            html += `<li>‚Ä¢ Modalit√†: <strong>${mode}</strong></li>`;
            html += `<li>‚Ä¢ Record totali: <strong>${totalRecords}</strong></li>`;
            html += `<li>‚Ä¢ Tempo elaborazione: <strong>${elapsedTime} secondi</strong></li>`;
            html += `<li>‚Ä¢ Performance: <strong>${recordsPerSecond} record/secondo</strong></li>`;
            html += `<li>‚Ä¢ Strategia: <strong>Singolo XML ‚Üí Singola chiamata API</strong></li>`;
            html += `</ul>`;
            html += '</div>';
            
            html += '</div>';
            content.innerHTML = html;
            section.classList.remove('hidden');
        }

        // ===== EVENT LISTENERS (mantenuti dal codice originale) =====

        document.getElementById('toggleKeyBtn').addEventListener('click', () => {
            const input = document.getElementById('apiKeyInput');
            input.type = input.type === 'password' ? 'text' : 'password';
        });

        document.getElementById('saveApiBtn').addEventListener('click', () => {
            const apiKey = document.getElementById('apiKeyInput').value.trim();
            if (!apiKey) {
                log('Inserisci l\'API key', 'error');
                return;
            }
            state.apiKey = apiKey;
            log('‚úÖ API key salvata!', 'success');
            document.getElementById('apiStatus').innerHTML = '<span class="status-ok">‚úÖ Configurato</span>';
            checkReadyState();
        });

        document.getElementById('debugBtn').addEventListener('click', getPdfInfo);
        document.getElementById('exportBtn').addEventListener('click', exportFormStructure);
        document.getElementById('convertBtn').addEventListener('click', convertXfaToAcroforms);
        document.getElementById('fallbackBtn').addEventListener('click', executeFallbackMode); // ‚úÖ NUOVO

        document.getElementById('selectCSVBtn').addEventListener('click', () => {
            document.getElementById('csvFileInput').click();
        });

        document.getElementById('csvFileInput').addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;
            log('Caricamento CSV...', 'info');
            const reader = new FileReader();
            reader.onload = (e) => {
                Papa.parse(e.target.result, {
                    header: true,
                    delimiter: ";",
                    skipEmptyLines: true,
                    complete: (results) => {
                        state.csvData = results.data.filter(row => row['COGNOME'] && row['COGNOME'].trim());
                        const recordCount = state.csvData.length;
                        
                        log(`‚úÖ CSV caricato: ${recordCount} record trovati`, 'success');
                        
                        // ‚úÖ NUOVO: Verifica capacit√† mega-batch
                        if (recordCount > 200) {
                            log(`‚ö†Ô∏è VOLUME ALTO: ${recordCount} record (>200) - Fallback raccomandato`, 'warn');
                        } else if (recordCount > 100) {
                            log(`üìä VOLUME MEDIO-ALTO: ${recordCount} record - Mega-batch ottimale`, 'megabatch');
                        } else {
                            log(`üìä VOLUME STANDARD: ${recordCount} record - Mega-batch veloce`, 'success');
                        }
                        
                        document.getElementById('csvStatus').innerHTML = `<span class="status-ok">‚úÖ ${recordCount} record</span>`;
                        showCSVPreview();
                        updateRecordCount();
                        updateMegaBatchStatus(); // ‚úÖ NUOVO
                        checkReadyState();
                    },
                    error: (error) => log(`‚ùå Errore parsing CSV: ${error.message}`, 'error')
                });
            };
            reader.readAsText(file, 'UTF-8');
        });

        function showCSVPreview() {
            const preview = document.getElementById('csvPreview');
            let html = '<table class="w-full text-xs">';
            html += '<thead><tr class="border-b">';
            Object.keys(state.fieldMapping).forEach(header => {
                html += `<th class="text-left p-1 text-[10px]">${header}</th>`;
            });
            html += '</tr></thead><tbody>';
            state.csvData.slice(0, 3).forEach((row) => {
                html += '<tr class="border-b">';
                Object.keys(state.fieldMapping).forEach(header => {
                    const value = row[header] || '';
                    html += `<td class="p-1 text-[10px]">${value.substring(0, 15)}${value.length > 15 ? '...' : ''}</td>`;
                });
                html += '</tr>';
            });
            html += '</tbody></table>';
            if (state.csvData.length > 3) {
                html += `<p class="text-center mt-2 text-gray-500">... e altri ${state.csvData.length - 3} record</p>`;
            }
            preview.innerHTML = html;
            preview.classList.remove('hidden');
        }

        document.getElementById('selectPDFBtn').addEventListener('click', () => {
            document.getElementById('pdfFileInput').click();
        });

        document.getElementById('pdfFileInput').addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;
            if (file.type !== 'application/pdf') {
                log('‚ùå Il file deve essere un PDF', 'error');
                return;
            }
            state.pdfFile = file;
            state.pdfResourceId = null;
            const sizeMB = (file.size / 1024 / 1024).toFixed(2);
            log(`üìÑ PDF selezionato: ${file.name} (${sizeMB} MB)`, 'success');
            document.getElementById('pdfStatus').innerHTML = `<span class="status-ok">‚úÖ ${file.name}</span>`;
            checkReadyState();
        });

        function updateRecordCount() {
            if (state.csvData) {
                const totalRecords = state.csvData.length;
                let message = `‚úÖ Pronti ${totalRecords} record per MEGA-BATCH processing`;
                
                if (totalRecords <= 50) {
                    message += ' (volume standard - elaborazione veloce)';
                } else if (totalRecords <= 100) {
                    message += ' (volume medio - mega-batch ottimale)';
                } else if (totalRecords <= 200) {
                    message += ' (volume alto - mega-batch + fallback ready)';
                } else {
                    message += ' (volume molto alto - fallback raccomandato)';
                }
                
                document.getElementById('recordCount').textContent = message;
            }
        }

        function checkReadyState() {
            const ready = state.apiKey && state.csvData && state.pdfFile;
            const compileBtn = document.getElementById('compileBtn');
            const debugBtn = document.getElementById('debugBtn');
            
            compileBtn.disabled = !ready;
            debugBtn.disabled = !state.pdfFile;
            document.getElementById('exportBtn').disabled = !state.pdfFile;
            document.getElementById('convertBtn').disabled = !state.pdfFile;
            
            if (ready) {
                compileBtn.style.background = '#f97316'; // Orange per mega-batch
                compileBtn.textContent = 'üöÄ MEGA-BATCH COMPILE';
            }
        }

        // ‚úÖ MEGA-BATCH: Compile button con nuova logica
        document.getElementById('compileBtn').addEventListener('click', async () => {
            if (!state.apiKey || !state.csvData || !state.pdfFile) {
                log('‚ùå Mancano dei prerequisiti', 'error');
                return;
            }
            
            const btn = document.getElementById('compileBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Mega-Batch in corso...';
            document.getElementById('processProgress').classList.remove('hidden');
            document.getElementById('fallbackSection').classList.add('hidden'); // Nascondi fallback
            
            try {
                // Upload PDF se necessario
                if (!state.pdfResourceId) {
                    updateProgress(5, 'Upload PDF...', 'Preparazione risorsa');
                    await uploadPDF();
                }
                
                updateProgress(15, 'Avvio mega-batch...', 'Modalit√† mega-batch attiva');
                await compilePDF_MegaBatch();
                
                btn.textContent = '‚úÖ Mega-Batch completato';
                btn.style.background = '#10b981';
                
            } catch (error) {
                log(`‚ùå Errore mega-batch: ${error.message}`, 'error');
                btn.disabled = false;
                btn.textContent = 'üöÄ MEGA-BATCH COMPILE';
                btn.style.background = '#f97316';
                document.getElementById('processProgress').classList.add('hidden');
            }
        });

        // ===== FUNZIONI ORIGINALI (mantenute per compatibilit√†) =====

        async function uploadPDF() {
            log('Upload PDF...', 'api');
            const formData = new FormData();
            formData.append('file', state.pdfFile);
            const response = await fetch(`${API_BASE}/upload`, {
                method: 'POST',
                body: formData
            });
            if (!response.ok) {
                const text = await response.text();
                throw new Error(`Upload fallito: ${text}`);
            }
            const data = await response.json();
            state.pdfResourceId = data.files[0].id;
            log(`‚úÖ PDF uploadato. ID: ${state.pdfResourceId}`, 'success');
        }

        async function getPdfInfo() {
            if (!state.pdfFile) {
                log('‚ùå Prima carica un PDF per analizzarlo!', 'error');
                return;
            }
            if (!state.pdfResourceId) {
                log('üî¨ Upload del PDF per l\'analisi in corso...', 'api');
                try {
                    await uploadPDF();
                } catch (e) {
                    log(`‚ùå Fallito l'upload per l'analisi: ${e.message}`, 'error');
                    return;
                }
            }

            log('üî¨ Richiesta informazioni sul PDF...', 'api');
            const form = new FormData();
            form.append('id', state.pdfResourceId);
            form.append('queries', 'contains_xfa,contains_acroforms,page_count,filename');

            try {
                const response = await fetch(`${API_BASE}/pdf-info`, {
                    method: 'POST',
                    body: form
                });

                if (!response.ok) {
                    const text = await response.text();
                    throw new Error(`Analisi fallita: ${text}`);
                }

                const data = await response.json();
                
                log('‚úÖ INFORMAZIONI PDF RICEVUTE!', 'success');
                log('-------------------------------------------', 'success');
                console.log('Dati completi ricevuti da /pdf-info:', data);
                
                const isXFA = String(data.contains_xfa).toLowerCase().includes('tr');
                const isAcroForm = String(data.contains_acroforms).toLowerCase().includes('tr');
                
                if (isXFA) {
                    log('üìã ‚úÖ PDF XFA rilevato! Perfetto per mega-batch processing.', 'success');
                    log('üöÄ MEGA-BATCH: Struttura auto-espandibile, supporta 200+ record', 'megabatch');
                } else if (isAcroForm) {
                    log('üìã ‚úÖ Acroforms rilevato! Compatibile per mega-batch.', 'success');
                } else {
                    log('‚ö†Ô∏è Il PDF non sembra contenere moduli compilabili standard', 'warn');
                }
                
                log(`üìÑ Numero di pagine: ${data.page_count}`, 'info');
                log(`üìÅ Nome file: ${data.filename}`, 'info');
                log('-------------------------------------------', 'success');

            } catch (error) {
                log(`‚ùå Errore durante l'analisi: ${error.message}`, 'error');
            }
        }

        async function exportFormStructure() {
            if (!state.pdfFile) {
                log('‚ùå Prima carica un PDF per estrarre la struttura!', 'error');
                return;
            }
            if (!state.pdfResourceId) {
                log('üì§ Upload del PDF per l\'estrazione in corso...', 'api');
                try {
                    await uploadPDF();
                } catch (e) {
                    log(`‚ùå Fallito l'upload per l'estrazione: ${e.message}`, 'error');
                    return;
                }
            }

            log('üì§ Estrazione struttura dati XFA...', 'api');
            const form = new FormData();
            form.append('id', state.pdfResourceId);
            form.append('data_format', 'xml');
            form.append('output', 'struttura_xfa');

            try {
                const response = await fetch(`${API_BASE}/exported-form-data`, {
                    method: 'POST',
                    body: form
                });

                if (!response.ok) {
                    const text = await response.text();
                    throw new Error(`Estrazione fallita: ${text}`);
                }

                const data = await response.json();
                
                log('‚úÖ STRUTTURA XFA ESTRATTA!', 'success');
                log('-------------------------------------------', 'success');
                log('üìã URL del file di struttura XML:', 'success');
                log(data.outputUrl, 'info');
                log('-------------------------------------------', 'success');
                
                console.log('Dati completi dalla struttura XFA:', data);
                
                if (data.outputUrl) {
                    try {
                        const xmlResponse = await fetch(data.outputUrl);
                        const xmlText = await xmlResponse.text();
                        log('üìã ANTEPRIMA STRUTTURA XML (primi 1000 caratteri):', 'success');
                        log(xmlText.substring(0, 1000) + '...', 'info');
                        console.log('Struttura XML completa:', xmlText);
                        
                        state.xfaStructure = xmlText;
                        
                    } catch (e) {
                        log('‚ÑπÔ∏è Non riesco a scaricare automaticamente, usa il link sopra', 'warn');
                    }
                }

            } catch (error) {
                log(`‚ùå Errore durante l'estrazione: ${error.message}`, 'error');
            }
        }

        async function convertXfaToAcroforms() {
            if (!state.pdfFile) {
                log('‚ùå Prima carica un PDF per convertirlo!', 'error');
                return;
            }
            if (!state.pdfResourceId) {
                log('üîÑ Upload del PDF per la conversione in corso...', 'api');
                try {
                    await uploadPDF();
                } catch (e) {
                    log(`‚ùå Fallito l'upload per la conversione: ${e.message}`, 'error');
                    return;
                }
            }

            log('üîÑ Conversione XFA ‚Üí Acroforms...', 'api');
            const form = new FormData();
            form.append('id', state.pdfResourceId);
            form.append('output', 'pdf_acroforms');

            try {
                const response = await fetch(`${API_BASE}/pdf-with-acroforms`, {
                    method: 'POST',
                    body: form
                });

                if (!response.ok) {
                    const text = await response.text();
                    throw new Error(`Conversione fallita: ${text}`);
                }

                const data = await response.json();
                
                log('‚úÖ XFA convertito in Acroforms!', 'success');
                log('-------------------------------------------', 'success');
                log('üìã PDF Acroforms generato:', 'success');
                log(data.outputUrl, 'info');
                log('-------------------------------------------', 'success');
                
                console.log('Dati completi dalla conversione:', data);
                state.acroformsPdfUrl = data.outputUrl;

            } catch (error) {
                log(`‚ùå Errore durante la conversione: ${error.message}`, 'error');
            }
        }

        document.getElementById('clearLogBtn').addEventListener('click', () => {
            document.getElementById('logArea').innerHTML = '';
            log('Log pulito', 'info');
        });

        // Initialize
        log('üöÄ Sistema Mega-Batch inizializzato - Supporto 200+ record', 'megabatch');
        log('üí° Modalit√†: Singolo XML ‚Üí Singola chiamata API con fallback automatico', 'info');
    </script>

</body>
</html>
